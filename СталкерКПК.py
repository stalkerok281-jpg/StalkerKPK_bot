import asyncio
import random
import logging
from datetime import datetime, timedelta
from typing import List, Dict, Optional

from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import Message
from aiogram.utils.markdown import bold

# ==================== –ù–ê–°–¢–†–û–ô–ö–ò ====================
TOKEN = "YOUR_BOT_TOKEN_HERE"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞

# –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
DEATH_MIN_INTERVAL = 8 * 60 * 60      # 8 —á–∞—Å–æ–≤ –º–µ–∂–¥—É —Å–º–µ—Ä—Ç—è–º–∏
DEATH_MAX_INTERVAL = 24 * 60 * 60     # 24 —á–∞—Å–∞ –º–µ–∂–¥—É —Å–º–µ—Ä—Ç—è–º–∏
EMISSION_INTERVAL = 48 * 60 * 60      # 48 —á–∞—Å–æ–≤ –º–µ–∂–¥—É –≤—ã–±—Ä–æ—Å–∞–º–∏
ARTIFACT_INTERVAL = 4 * 60 * 60       # 4 —á–∞—Å–∞ –º–µ–∂–¥—É –Ω–∞—Ö–æ–¥–∫–∞–º–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
QUEST_INTERVAL = 12 * 60 * 60         # 12 —á–∞—Å–æ–≤ –º–µ–∂–¥—É –∫–≤–µ—Å—Ç–∞–º–∏
GUIDE_INTERVAL = 6 * 60 * 60          # 6 —á–∞—Å–æ–≤ –º–µ–∂–¥—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏ –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–æ–≤

# –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤—ã–±—Ä–æ—Å–∞ –≤ –º–æ–º–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ (10%)
EMISSION_PROBABILITY = 0.1

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
bot = Bot(token=TOKEN)
dp = Dispatcher()

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤
active_chats: Dict[int, Dict] = {}

# ==================== –î–ê–ù–ù–´–ï –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò ====================
# –ò–º–µ–Ω–∞ —Å—Ç–∞–ª–∫–µ—Ä–æ–≤
STALKER_NAMES = [
    "–í–∞–ª–∏–∫", "–õ–∏—Å", "–®—É—Å—Ç—Ä—ã–π", "–ö—É–∑—å–º–∞", "–°–∫–µ–ª–µ—Ç", "–ë–æ—Ä–æ–¥–∞", "–í–µ–Ω–æ–º",
    "–ü—Ä–∏–∑—Ä–∞–∫", "–ú–∞—Ö–Ω–æ", "–§–∏–ª–∏–Ω", "–ì—Ä–µ–π", "–ö–ª–µ—â", "–®—Ä–∞–º", "–í–æ–ª–∫",
    "–õ–µ–¥", "–ú–∞–ª—ã—à", "–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä", "–°—ã—á", "–õ—ã—Å—ã–π", "–†—ã–∂–∏–π", "–•–∏–º–∏–∫",
    "–î–æ–∫", "–í–∞—Ä—è–≥", "–ì–≤–æ–∑–¥—å", "–°—Ç—É–¥–µ–Ω—Ç", "–®–∞—Ö—Ç–µ—Ä", "–§–∞–Ω—Ç–æ–º", "–ú–æ–Ω–≥–æ–ª",
    "–ë–æ—Ü–º–∞–Ω", "–®–µ–ø—Ç—É–Ω", "–ì–æ–±–ª–∏–Ω", "–ö—É–±–∏–∫", "–ü—Å–∏—Ö", "–§–∏–∫—Å"
]

# –ö–ª–∏—á–∫–∏ (–ø—Ä–æ–∑–≤–∏—â–∞)
STALKER_NICKNAMES = [
    "–°–Ω–∞–π–ø–µ—Ä", "–ë—É–π–Ω—ã–π", "–¢–∏—Ö–∏–π", "–ì—Ä–æ–º", "–ö–æ—Å–æ–π", "–ë—Ä–æ–¥—è–≥–∞", "–í–æ—Ä–æ–Ω",
    "–°–µ–¥–æ–π", "–†–≤–∞–Ω—ã–π", "–•—Ä–æ–º–æ–π", "–®–µ–ø—Ç—É–Ω", "–î–æ–ª–≥–æ–≤—è–∑—ã–π", "–ü—É–ª–µ–º–µ—Ç—á–∏–∫",
    "–ó–ª–æ–π", "–î–æ–±—Ä—è–∫", "–ö–æ—à–∞—Ç–Ω–∏–∫", "–ì–∏—Ç–∞—Ä–∏—Å—Ç", "–ë–∞—Ä—ã–≥–∞", "–°–∞–ø–µ—Ä",
    "–ö—É–∑–Ω–µ—Ü", "–®–∞—Ö—Ç–µ—Ä", "–ú–µ–¥–≤–µ–¥—å", "–õ–∏—Å–∞", "–®–∞–∫–∞–ª", "–ë–∞—Ä—Å—É–∫",
    "–í–æ–ª–∫–æ–¥–∞–≤", "–ì–ª–∞–¥–∏–∞—Ç–æ—Ä", "–ö–ª—ã–∫", "–ö–æ–≥–æ—Ç—å", "–í–∏—Ö—Ä—å"
]

# –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
FACTIONS = ["—Å—Ç–∞–ª–∫–µ—Ä", "–±–∞–Ω–¥–∏—Ç", "–≤–æ–µ–Ω–Ω—ã–π", "–Ω–∞–µ–º–Ω–∏–∫", "–º–æ–Ω–æ–ª–∏—Ç", "–¥–æ–ª–≥", "—Å–≤–æ–±–æ–¥–∞", "—ç–∫–æ–ª–æ–≥"]

# –ü—Ä–∏—á–∏–Ω—ã —Å–º–µ—Ä—Ç–∏
DEATH_REASONS = [
    "–≤–æ—Ä–æ–Ω–∫–∞", "–∞–Ω–æ–º–∞–ª–∏—è '—Ç—Ä–∞–º–ø–ª–∏–Ω'", "–∞–Ω–æ–º–∞–ª–∏—è '–∂–∞—Ä–∫–∞'", "–∞–Ω–æ–º–∞–ª–∏—è '–∫–∞—Ä—É—Å–µ–ª—å'",
    "–∫—Ä–æ–≤–æ—Å–æ—Å", "–±—é—Ä–µ—Ä", "–ø—Å–µ–≤–¥–æ–≥–∏–≥–∞–Ω—Ç", "—Å–Ω–æ—Ä–∫", "–∫–∞–±–∞–Ω", "–ø–ª–æ—Ç—å",
    "—Å–ª–µ–ø–æ–π –ø–µ—Å", "–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä", "–ø–æ–ª—Ç–µ—Ä–≥–µ–π—Å—Ç", "—Ö–∏–º–µ—Ä–∞", "–ø—Å–µ–≤–¥–æ—Å–æ–±–∞–∫–∞",
    "–±–∞–Ω–¥—é–∫–∏", "–¥–æ–ª–≥", "—Å–≤–æ–±–æ–¥–∞", "–º–æ–Ω–æ–ª–∏—Ç", "–Ω–∞–µ–º–Ω–∏–∫–∏", "–∑–æ–º–±–∏",
    "–≤—ã–±—Ä–æ—Å", "—Ä–∞–¥–∏–∞—Ü–∏—è", "–≥–æ–ª–æ–¥", "–º—É—Ç–∞–Ω—Ç—ã", "–º–∞—Ä–æ–¥–µ—Ä—ã"
]

# –õ–æ–∫–∞—Ü–∏–∏
LOCATIONS = [
    "–ö–æ—Ä–¥–æ–Ω", "–°–≤–∞–ª–∫–∞", "–¢–µ–º–Ω–∞—è –¥–æ–ª–∏–Ω–∞", "–ê–≥—Ä–æ–ø—Ä–æ–º", "–Ø–Ω—Ç–∞—Ä—å",
    "–ë–æ–ª–æ—Ç–∞", "–ë–∞—Ä", "–†–∞–¥–∞—Ä", "–ß–ê–≠–°", "–ü—Ä–∏–ø—è—Ç—å", "–ó–∞—Ç–æ–Ω",
    "–Æ–ø–∏—Ç–µ—Ä", "–ó–ê–¢–û –Ø–Ω—Ç–∞—Ä—å", "–õ–∏–º–∞–Ω—Å–∫", "–ö—Ä–∞—Å–Ω—ã–π –ª–µ—Å", "–ú–µ—Ä—Ç–≤—ã–π –≥–æ—Ä–æ–¥",
    "–†—ã–∂–∏–π –ª–µ—Å", "–ê—Ä–º–µ–π—Å–∫–∏–µ —Å–∫–ª–∞–¥—ã", "–î–∏–∫–∞—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è"
]

# –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
ARTIFACTS = [
    "–ú–µ–¥—É–∑–∞", "–ì—Ä–∞–≤–∏", "–ü—É–∑—ã—Ä—å", "–ö–∞–º–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç–æ–∫", "–°–ª–∏–∑–µ–Ω—å",
    "–ö–æ–≥–æ—Ç—å", "–ì–ª–∞–∑", "–ó–æ–ª–æ—Ç–∞—è —Ä—ã–±–∫–∞", "–ù–æ—á–Ω–∞—è –∑–≤–µ–∑–¥–∞", "–ö–∞–ø–ª—è",
    "–õ—É–Ω–Ω—ã–π —Å–≤–µ—Ç", "–í—ã–≤–µ—Ä—Ç", "–ö—Ä–æ–≤—å –∫–∞–º–Ω—è", "–î—É—à–∞", "–ü–ª–æ—Ç—å",
    "–©—É–ø–∞–ª—å—Ü–µ", "–ü–ª–µ–Ω–∫–∞", "–í–µ–¥—å–º–∏–Ω–æ –∂–µ–ª–µ", "–ë–µ–Ω–≥–∞–ª—å—Å–∫–∏–π –æ–≥–æ–Ω—å", "–ú–æ—Ä—Å–∫–æ–π –µ–∂"
]

# –ó–∞–¥–∞–Ω–∏—è –∏ –∫–≤–µ—Å—Ç—ã
QUESTS = [
    "–ü—Ä–∏–Ω–µ—Å—Ç–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç '–ú–µ–¥—É–∑–∞' —Å –¢–µ–º–Ω–æ–π –¥–æ–ª–∏–Ω—ã. –ù–∞–≥—Ä–∞–¥–∞: 5000 RU",
    "–ó–∞—á–∏—Å—Ç–∏—Ç—å –ø–æ–¥–∑–µ–º–µ–ª—å—è –ê–≥—Ä–æ–ø—Ä–æ–º–∞ –æ—Ç –º—É—Ç–∞–Ω—Ç–æ–≤. –ù–∞–≥—Ä–∞–¥–∞: 8000 RU",
    "–ù–∞–π—Ç–∏ –ø—Ä–æ–ø–∞–≤—à—É—é –≥—Ä—É–ø–ø—É —Å—Ç–∞–ª–∫–µ—Ä–æ–≤ –Ω–∞ –Ø–Ω—Ç–∞—Ä–µ. –ù–∞–≥—Ä–∞–¥–∞: 3000 RU",
    "–°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç—å —É—á–µ–Ω–æ–≥–æ –¥–æ –Ø–Ω—Ç–∞—Ä—è. –ù–∞–≥—Ä–∞–¥–∞: 10000 RU",
    "–£–Ω–∏—á—Ç–æ–∂–∏—Ç—å –±–∞–Ω–¥—É –Ω–∞ –°–≤–∞–ª–∫–µ. –ù–∞–≥—Ä–∞–¥–∞: 7000 RU",
    "–î–æ—Å—Ç–∞–≤–∏—Ç—å –¥–µ—Ç–µ–∫—Ç–æ—Ä –Ω–∞ –ö–æ—Ä–¥–æ–Ω. –ù–∞–≥—Ä–∞–¥–∞: 2000 RU",
    "–†–∞–∑–≤–µ–¥–∞—Ç—å –æ–±—Å—Ç–∞–Ω–æ–≤–∫—É –Ω–∞ –†–∞–¥–∞—Ä–µ. –ù–∞–≥—Ä–∞–¥–∞: 15000 RU",
    "–ù–∞–π—Ç–∏ –∏ –¥–æ—Å—Ç–∞–≤–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç '–ö–æ–≥–æ—Ç—å'. –ù–∞–≥—Ä–∞–¥–∞: 12000 RU",
    "–£—Å—Ç—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞ –≤ –ø–æ–¥–∑–µ–º–µ–ª—å—è—Ö. –ù–∞–≥—Ä–∞–¥–∞: 20000 RU",
    "–°–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑—Ü—ã –∫—Ä–æ–≤–∏ –º—É—Ç–∞–Ω—Ç–æ–≤. –ù–∞–≥—Ä–∞–¥–∞: 6000 RU"
]

# –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–æ–≤
GUIDE_OFFERS = [
    "–ü—Ä–æ–≤–µ–¥—É –¥–æ –ë–∞—Ä–∞. –¶–µ–Ω–∞: 3000 RU",
    "–ì—Ä—É–ø–ø–∞ –Ω–∞ –Ø–Ω—Ç–∞—Ä—å, –Ω—É–∂–µ–Ω –µ—â–µ –æ–¥–∏–Ω. –ú–µ—Å—Ç–æ —Å–±–æ—Ä–∞: –ö–æ—Ä–¥–æ–Ω",
    "–ò–¥—É –Ω–∞ –†–∞–¥–∞—Ä, –Ω—É–∂–Ω—ã –ø–æ–ø—É—Ç—á–∏–∫–∏. –û–ø–ª–∞—Ç–∞: –ø—Ä–æ–≤–æ–¥–∫–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ",
    "–°—Ä–æ—á–Ω–æ –Ω—É–∂–µ–Ω –ø—Ä–æ–≤–æ–¥–Ω–∏–∫ –¥–æ –ß–ê–≠–°. –û–ø–ª–∞—Ç–∞: –∞—Ä—Ç–µ—Ñ–∞–∫—Ç",
    "–ü—Ä–æ–≤–æ–∂—É –¥–æ –õ–∏–º–∞–Ω—Å–∫–∞. –ó–Ω–∞—é –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø—É—Ç—å",
    "–ò—â–µ–º –æ–ø—ã—Ç–Ω–æ–≥–æ –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–∞ –Ω–∞ –Æ–ø–∏—Ç–µ—Ä. –û–ø–ª–∞—Ç–∞ 5000 + —Ö–∞–±–∞—Ä",
    "–ù–∞ –ê—Ä–º–µ–π—Å–∫–∏–µ —Å–∫–ª–∞–¥—ã, –∏–¥–µ–º –∑–∞–≤—Ç—Ä–∞ —É—Ç—Ä–æ–º. –î–≤–∞ –º–µ—Å—Ç–∞",
    "–ü—Ä–æ–≤–æ–∂—É –≥—Ä—É–ø–ø—É —á–µ—Ä–µ–∑ –í—ã–∂–∏–≥–∞—Ç–µ–ª—å –º–æ–∑–≥–æ–≤. –ù—É–∂–Ω—ã –¥–æ–±—Ä–æ–≤–æ–ª—å—Ü—ã",
    "–ù–∞ –ü—Ä–∏–ø—è—Ç—å, –≤—ã–¥–≤–∏–≥–∞–µ–º—Å—è —á–µ—Ä–µ–∑ —á–∞—Å. –°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ –ø—Ä–∏ —Å–µ–±–µ",
    "–í –¢–µ–º–Ω—É—é –¥–æ–ª–∏–Ω—É, –ø–ª–∞—Ç–∞ 2000. –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å"
]

# ==================== –§–£–ù–ö–¶–ò–ò –ì–ï–ù–ï–†–ê–¶–ò–ò ====================
def generate_death_message() -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–º–µ—Ä—Ç–∏ —Å—Ç–∞–ª–∫–µ—Ä–∞"""
    name = random.choice(STALKER_NAMES)
    nickname = random.choice(STALKER_NICKNAMES)
    faction = random.choice(FACTIONS)
    location = random.choice(LOCATIONS)
    reason = random.choice(DEATH_REASONS)
    
    templates = [
        f"‚ö†Ô∏è –ü–æ–≥–∏–± {faction} {name} '{nickname}', {location}, {reason}.",
        f"üíÄ {faction} {name} {nickname} –º–µ—Ä—Ç–≤, {location}, {reason}.",
        f"‚ò†Ô∏è –ù–µ –≤–µ—Ä–Ω—É–ª—Å—è —Å —Ö–æ–¥–∫–∏ {faction} {name} '{nickname}', {location}, {reason}.",
        f"‚ö∞Ô∏è –ü–æ—Ö–æ—Ä–æ–Ω–∏–ª–∏ {faction} {name} '{nickname}', {location}, –ø—Ä–∏—á–∏–Ω–∞ —Å–º–µ—Ä—Ç–∏: {reason}.",
        f"üìª –í–Ω–∏–º–∞–Ω–∏–µ! {faction} {name} '{nickname}' –ø–æ–≥–∏–± –≤ {location}, {reason}."
    ]
    
    return random.choice(templates)

def generate_emission_sequence() -> List[str]:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–µ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –æ –≤—ã–±—Ä–æ—Å–µ (4 —Å–æ–æ–±—â–µ–Ω–∏—è)"""
    messages = [
        "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–ù–ê –°–ï–ô–°–ú–ò–ß–ï–°–ö–ê–Ø –ê–ö–¢–ò–í–ù–û–°–¢–¨!",
        "üå™Ô∏è –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ—Ç—Å—è –≤—ã–±—Ä–æ—Å! –ú–æ—â–Ω–æ—Å—Ç—å: {} –ú–≠—Ä".format(random.randint(3, 7)),
        "üèÉ –°—Ä–æ—á–Ω–æ —É–∫—Ä—ã—Ç—å—Å—è –≤ –±–ª–∏–∂–∞–π—à–µ–º —É–±–µ–∂–∏—â–µ! –ü–æ–≤—Ç–æ—Ä—è—é, –≤—Å–µ–º —É–∫—Ä—ã—Ç—å—Å—è!",
        "‚è±Ô∏è –î–æ –ø—Ä–∏—Ö–æ–¥–∞ –≤–æ–ª–Ω—ã: {} –º–∏–Ω—É—Ç. –ë–µ—Ä–µ–≥–∏—Ç–µ —Å–µ–±—è, —Å—Ç–∞–ª–∫–µ—Ä—ã!".format(random.randint(5, 15))
    ]
    return messages

def generate_artifact_message() -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—Ö–æ–¥–∫–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞"""
    name = random.choice(STALKER_NAMES)
    nickname = random.choice(STALKER_NICKNAMES)
    faction = random.choice(FACTIONS)
    artifact = random.choice(ARTIFACTS)
    location = random.choice(LOCATIONS)
    price = random.randint(3, 15) * 1000
    
    templates = [
        f"üéÅ {faction} {name} '{nickname}' –Ω–∞—à–µ–ª –∞—Ä—Ç–µ—Ñ–∞–∫—Ç '{artifact}' –≤ {location}. –ü—Ä–æ–¥–∞–µ—Ç –∑–∞ {price} RU",
        f"üí∞ –°–≤–µ–∂–∏–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç! {faction} {name} {nickname} –Ω–∞—à–µ–ª '{artifact}' –≤ {location}. –¢–æ—Ä–≥ —É–º–µ—Å—Ç–µ–Ω",
        f"üíé –í–Ω–∏–º–∞–Ω–∏–µ! –í {location} –Ω–∞–π–¥–µ–Ω –∞—Ä—Ç–µ—Ñ–∞–∫—Ç '{artifact}'. –û–±—Ä–∞—â–∞—Ç—å—Å—è –∫ {faction} {name} '{nickname}'",
        f"‚ö° {faction} {name} '{nickname}' –ø—Ä–æ–¥–∞–µ—Ç —Ä–µ–¥–∫–∏–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç '{artifact}', –Ω–∞–π–¥–µ–Ω–Ω—ã–π –≤ {location}. –¶–µ–Ω–∞: {price} RU",
        f"üì¢ {faction} {name} {nickname} —Å–æ–æ–±—â–∞–µ—Ç –æ –Ω–∞—Ö–æ–¥–∫–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ '{artifact}' –≤ —Ä–∞–π–æ–Ω–µ {location}. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤ –õ–°"
    ]
    
    return random.choice(templates)

def generate_quest_message() -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–¥–∞–Ω–∏–µ–º"""
    quest = random.choice(QUESTS)
    customer = random.choice(["—É—á–µ–Ω—ã–π", "—Ç–æ—Ä–≥–æ–≤–µ—Ü", "—Å—Ç–∞–ª–∫–µ—Ä", "–±–∞–Ω–¥–∏—Ç", "–≤–æ–µ–Ω–Ω—ã–π"])
    
    templates = [
        f"üìã –ó–∞–¥–∞–Ω–∏–µ –æ—Ç {customer}: {quest}",
        f"‚ö° –°—Ä–æ—á–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ ({customer}): {quest}",
        f"üìå –í–Ω–∏–º–∞–Ω–∏–µ —Å—Ç–∞–ª–∫–µ—Ä—ã! {customer} –¥–∞–µ—Ç –∑–∞–¥–∞–Ω–∏–µ: {quest}",
        f"üéØ –î–æ—Å–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π ({customer}): {quest}",
        f"üì¢ {customer} –∏—â–µ—Ç —Å—Ç–∞–ª–∫–µ—Ä–æ–≤ –¥–ª—è –∑–∞–¥–∞–Ω–∏—è: {quest}"
    ]
    
    return random.choice(templates)

def generate_guide_message() -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–∞"""
    offer = random.choice(GUIDE_OFFERS)
    guide_name = random.choice(STALKER_NAMES)
    guide_nick = random.choice(STALKER_NICKNAMES)
    
    return f"üö∂ –ü—Ä–æ–≤–æ–¥–Ω–∏–∫ {guide_name} '{guide_nick}': {offer}"

def generate_random_message() -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
    messages = [
        "üé∏ –ù–∞ –±–∞–∑–µ —Å–ª—ã—à–Ω–∞ –≥–∏—Ç–∞—Ä–∞... –ö—Ç–æ-—Ç–æ –ø–æ–µ—Ç –ø—Ä–æ –ó–æ–Ω—É",
        "üçû –ü—Ä–∏–µ—Ö–∞–ª —Ç–æ—Ä–≥–æ–≤–µ—Ü —Å —Å–≤–µ–∂–∏–º —Ö–ª–µ–±–æ–º. –ë—É–¥—å—Ç–µ –≤–µ–∂–ª–∏–≤—ã",
        "‚ö° –ê–Ω–æ–º–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è –≤—ã—à–µ –æ–±—ã—á–Ω–æ–≥–æ",
        "üåô –ì–æ–≤–æ—Ä—è—Ç, –≤ –ø–æ–ª–Ω–æ–ª—É–Ω–∏–µ –º—É—Ç–∞–Ω—Ç—ã –æ—Å–æ–±–µ–Ω–Ω–æ –∑–ª—ã–µ",
        "‚òï –£ –°–∏–¥–æ—Ä–æ–≤–∏—á–∞ —Å–≤–µ–∂–∏–π –∫–æ—Ñ–µ. –ó–∞—Ö–æ–¥–∏—Ç–µ –ø–æ–≥—Ä–µ—Ç—å—Å—è",
        "üìª –°—Ç–∞–ª–∫–µ—Ä—Å–∫–æ–µ —Ä–∞–¥–∏–æ –ø–µ—Ä–µ–¥–∞–µ—Ç –º—É–∑—ã–∫—É –ø—Ä–æ—à–ª–æ–≥–æ",
        "üé≤ –í –±–∞—Ä–µ –∏–¥–µ—Ç –∏–≥—Ä–∞ –≤ –ø–æ–∫–µ—Ä. –ö—Ç–æ —Å–º–µ–ª—ã–π?",
        "üíä –ê–ø—Ç–µ—á–∫–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å —É —Ç–æ—Ä–≥–æ–≤—Ü–∞. –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã –≤ —Ö–æ–¥–∫–µ",
        "üî¶ –ö—Ç–æ-—Ç–æ –ø–æ—Ç–µ—Ä—è–ª —Ñ–æ–Ω–∞—Ä—å –Ω–∞ –ö–æ—Ä–¥–æ–Ω–µ. –°–ø—Ä–æ—Å–∏—Ç–µ —É –°–∏–¥–æ—Ä–æ–≤–∏—á–∞",
        "üêï –°–ª–µ–ø—ã–µ –ø—Å—ã —Å–µ–≥–æ–¥–Ω—è –æ—Å–æ–±–µ–Ω–Ω–æ –∞–∫—Ç–∏–≤–Ω—ã. –î–µ—Ä–∂–∏—Ç–µ—Å—å –≥—Ä—É–ø–ø–æ–π",
        "üåßÔ∏è –û–∂–∏–¥–∞–µ—Ç—Å—è –¥–æ–∂–¥—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≥–µ—Ä–º–µ—Ç–∏—á–Ω–æ—Å—Ç—å –∫–æ—Å—Ç—é–º–æ–≤",
        "üé≠ –ú–∞—Å–∫–∏—Ä–æ–≤–æ—á–Ω—ã–µ —Ö–∞–ª–∞—Ç—ã –≤ –Ω–∞–ª–∏—á–∏–∏ —É –ë–∞—Ä–º–µ–Ω–∞"
    ]
    return random.choice(messages)

def get_next_interval(min_interval: int, max_interval: int) -> int:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ —Å–µ–∫—É–Ω–¥–∞—Ö"""
    return random.randint(min_interval, max_interval)

# ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ====================
@dp.message(Command("start"))
async def cmd_start(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    chat_id = message.chat.id
    chat_name = message.chat.title or f"—á–∞—Ç {chat_id}"
    
    # –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ
    if chat_id not in active_chats:
        active_chats[chat_id] = {
            'name': chat_name,
            'added_date': datetime.now(),
            'message_count': 0
        }
        logger.info(f"–ß–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω: {chat_name} (ID: {chat_id})")
    
    await message.answer(
        "üëã –°—Ç–∞–ª–∫–µ—Ä, –¥–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ï–¥–∏–Ω—É—é —Å—Ç–∞–ª–∫–µ—Ä—Å–∫—É—é —Å–µ—Ç—å!\n\n"
        "üì° –Ø –±—É–¥—É –ø—Ä–∏—Å—ã–ª–∞—Ç—å —Å–≤–æ–¥–∫–∏ –æ –ø—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏—è—Ö –≤ –ó–æ–Ω–µ:\n"
        "‚Ä¢ üíÄ –°–º–µ—Ä—Ç–∏ —Å—Ç–∞–ª–∫–µ—Ä–æ–≤\n"
        "‚Ä¢ üå™Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –≤—ã–±—Ä–æ—Å–∞—Ö\n"
        "‚Ä¢ üíé –ù–∞—Ö–æ–¥–∫–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤\n"
        "‚Ä¢ üìã –ö–≤–µ—Å—Ç—ã –∏ –∑–∞–¥–∞–Ω–∏—è\n"
        "‚Ä¢ üö∂ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–æ–≤\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/status - —Å—Ç–∞—Ç—É—Å —Å–µ—Ç–∏\n"
        "/test - —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n"
        "/stop - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É"
    )

@dp.message(Command("status"))
async def cmd_status(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /status"""
    chat_id = message.chat.id
    
    if chat_id not in active_chats:
        active_chats[chat_id] = {
            'name': message.chat.title or f"—á–∞—Ç {chat_id}",
            'added_date': datetime.now(),
            'message_count': 0
        }
    
    chat_info = active_chats[chat_id]
    
    await message.answer(
        f"üì° –ï–¥–∏–Ω–∞—è —Å—Ç–∞–ª–∫–µ—Ä—Å–∫–∞—è —Å–µ—Ç—å –∞–∫—Ç–∏–≤–Ω–∞\n"
        f"üü¢ –°–≤—è–∑—å —Å –ó–æ–Ω–æ–π —É—Å—Ç–æ–π—á–∏–≤–∞—è\n"
        f"üìä –†–µ–∂–∏–º: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞\n"
        f"üì® –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {chat_info['message_count']}"
    )

@dp.message(Command("test"))
async def cmd_test(message: Message):
    """–¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π"""
    await message.answer("üîÑ –¢–µ—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:")
    await asyncio.sleep(1)
    await message.answer(generate_death_message())
    await asyncio.sleep(1)
    await message.answer(generate_artifact_message())
    await asyncio.sleep(1)
    await message.answer(generate_quest_message())
    await asyncio.sleep(1)
    await message.answer(generate_guide_message())
    await asyncio.sleep(1)
    await message.answer(generate_random_message())

@dp.message(Command("stop"))
async def cmd_stop(message: Message):
    """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ –≤ —Ç–µ–∫—É—â–µ–º —á–∞—Ç–µ"""
    chat_id = message.chat.id
    if chat_id in active_chats:
        del active_chats[chat_id]
        await message.answer("üõë –†–∞—Å—Å—ã–ª–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ —ç—Ç–æ–º —á–∞—Ç–µ")
        logger.info(f"–ß–∞—Ç —É–¥–∞–ª–µ–Ω –∏–∑ —Ä–∞—Å—Å—ã–ª–∫–∏: {chat_id}")
    else:
        await message.answer("‚ùì –≠—Ç–æ—Ç —á–∞—Ç –Ω–µ –±—ã–ª –≤ —Å–ø–∏—Å–∫–µ —Ä–∞—Å—Å—ã–ª–∫–∏")

@dp.message()
async def handle_any_message(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ª—é–±–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —á–∞—Ç"""
    chat_id = message.chat.id
    
    # –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ, –µ—Å–ª–∏ –µ–≥–æ —Ç–∞–º –Ω–µ—Ç
    if chat_id not in active_chats:
        active_chats[chat_id] = {
            'name': message.chat.title or f"—á–∞—Ç {chat_id}",
            'added_date': datetime.now(),
            'message_count': 0
        }
        logger.info(f"–ß–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω: {message.chat.title} (ID: {chat_id})")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await message.answer(
            "üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é, —Å—Ç–∞–ª–∫–µ—Ä! –≠—Ç–æ—Ç —á–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ï–¥–∏–Ω—É—é —Å—Ç–∞–ª–∫–µ—Ä—Å–∫—É—é —Å–µ—Ç—å.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π /start –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏."
        )

# ==================== –§–û–ù–û–í–´–ï –ó–ê–î–ê–ß–ò ====================
async def message_scheduler():
    """–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π"""
    last_death_time = datetime.now()
    last_emission_time = datetime.now()
    last_artifact_time = datetime.now()
    last_quest_time = datetime.now()
    last_guide_time = datetime.now()
    last_random_time = datetime.now()
    
    while True:
        try:
            if not active_chats:
                logger.info("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤, –∂–¥–µ–º...")
                await asyncio.sleep(60)
                continue
            
            current_time = datetime.now()
            messages_to_send = []
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            if (current_time - last_death_time).total_seconds() > get_next_interval(DEATH_MIN_INTERVAL, DEATH_MAX_INTERVAL):
                messages_to_send.append(("—Å–º–µ—Ä—Ç—å", generate_death_message()))
                last_death_time = current_time
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤—ã–±—Ä–æ—Å–∞
                if random.random() < EMISSION_PROBABILITY:
                    await asyncio.sleep(random.randint(30, 300))
                    for msg in generate_emission_sequence():
                        messages_to_send.append(("–≤—ã–±—Ä–æ—Å", msg))
                        await asyncio.sleep(random.randint(30, 120))
            
            if (current_time - last_emission_time).total_seconds() > EMISSION_INTERVAL:
                for msg in generate_emission_sequence():
                    messages_to_send.append(("–≤—ã–±—Ä–æ—Å", msg))
                last_emission_time = current_time
            
            if (current_time - last_artifact_time).total_seconds() > ARTIFACT_INTERVAL:
                messages_to_send.append(("–∞—Ä—Ç–µ—Ñ–∞–∫—Ç", generate_artifact_message()))
                last_artifact_time = current_time
            
            if (current_time - last_quest_time).total_seconds() > QUEST_INTERVAL:
                messages_to_send.append(("–∫–≤–µ—Å—Ç", generate_quest_message()))
                last_quest_time = current_time
            
            if (current_time - last_guide_time).total_seconds() > GUIDE_INTERVAL:
                messages_to_send.append(("–ø—Ä–æ–≤–æ–¥–Ω–∏–∫", generate_guide_message()))
                last_guide_time = current_time
            
            # –°–ª—É—á–∞–π–Ω—ã–µ –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (—Ä–∞–∑ –≤ 2-4 —á–∞—Å–∞)
            if random.random() < 0.3:  # 30% —à–∞–Ω—Å –ø—Ä–∏ –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ
                messages_to_send.append(("–∞—Ç–º–æ—Å—Ñ–µ—Ä–∞", generate_random_message()))
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ –Ω–∞–∫–æ–ø–∏–≤—à–∏–µ—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è
            for msg_type, msg_text in messages_to_send:
                for chat_id in list(active_chats.keys()):
                    try:
                        await bot.send_message(chat_id, msg_text)
                        active_chats[chat_id]['message_count'] += 1
                        logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {msg_type} –≤ —á–∞—Ç {chat_id}")
                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —á–∞—Ç {chat_id}: {e}")
                        if "Forbidden" in str(e) or "chat not found" in str(e):
                            logger.info(f"–£–¥–∞–ª—è–µ–º —á–∞—Ç {chat_id} –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö")
                            active_chats.pop(chat_id, None)
            
            # –ñ–¥–µ–º –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
            await asyncio.sleep(300)  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ message_scheduler: {e}")
            await asyncio.sleep(60)

# ==================== –ó–ê–ü–£–°–ö –ë–û–¢–ê ====================
async def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞"""
    logger.info("–ë–æ—Ç –ï–¥–∏–Ω–æ–π —Å—Ç–∞–ª–∫–µ—Ä—Å–∫–æ–π —Å–µ—Ç–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    logger.info("–û–∂–∏–¥–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ —á–∞—Ç—ã...")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∫–∞–∫ —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
    asyncio.create_task(message_scheduler())
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–ª–∏–Ω–≥
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
